# goaurrpc
#### An implementation of the [aurweb](https://gitlab.archlinux.org/archlinux/aurweb) (v6) - /rpc - REST API service in go

This project implements the /rpc endpoints (REST API) as described [here](https://aur.archlinux.org/rpc/), as well as the "suggest" type.  
For the moment it should be considered being a proof-of-concept.  
While it should be fully functional, it still needs a bit more love (writing test, etc.) :wink:  

Main goal is to increase the performance of REST API.  

### Areas of improvement

In the current version (aurweb v6.0.13 was used for comparison/benchmarking), the bottleneck seems to be the database access.  
When a client makes a request an SQL statement is generated and a query is being run against the mariadb server.  
A pretty normal scenario in web application.

While the /rpc endpoint itself is implemented in asynchronous way, it does not seem to scale down to the database level.  
The queries are performed synchronously it seems, hence only once CPU core can be utilized.  
Could be that Arch is running multiple instances of aurweb (utilizing the same DB backend) to mitigate that issue though.  

Here an example while 10 concurrent requests are being performed.  
We can see that only one CPU core is utilized for the processing:

```
top - 18:03:13 up  4:56,  2 users,  load average: 0.97, 0.61, 0.65
Tasks: 141 total,   1 running, 140 sleeping,   0 stopped,   0 zombie
%Cpu(s): 25.0 us,  0.1 sy,  0.0 ni, 74.8 id,  0.0 wa,  0.1 hi,  0.1 si,  0.0 st
MiB Mem :  15697.7 total,  11966.5 free,    718.2 used,   3013.0 buff/cache
MiB Swap:      0.0 total,      0.0 free,      0.0 used.  14649.6 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 160623 mysql     20   0  687132 116452  22064 S  95.3   0.7  13:50.31 mariadbd
 160801 moson     20   0  163860 101148  26696 S   5.0   0.6   0:17.35 python
```

The same scenario with goaurrpc (on a 4-core machine).  
We see that all CPU cores are being used:

```
top - 18:06:58 up  4:59,  2 users,  load average: 0.62, 0.58, 0.63
Tasks: 140 total,   2 running, 138 sleeping,   0 stopped,   0 zombie
%Cpu(s): 97.9 us,  1.2 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.2 hi,  0.6 si,  0.0 st
MiB Mem :  15697.7 total,  11934.9 free,    749.3 used,   3013.5 buff/cache
MiB Swap:      0.0 total,      0.0 free,      0.0 used.  14618.4 avail Mem 

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 160573 moson     20   0 1638552 235232   5216 R 395.7   1.5   1:24.87 goaurrpc
``` 

### Thoughts

##### In-Memory DB

Since the /rpc endpoint only returns data and does not need to perform any CUD operations, we could hold the package data in memory as well.

Like in the following scenario:

* Fetch all the necessary data from the database in keep it in memory.
* Assemble the data that is being returned to the client from the in-memory data.
* Periodically refresh the data

Doing that you don't need to bother about expensive database queries to your RDBMS.  
You'd run one big query every now and then to get fresh data...

Now for this POC we'll be using package data that is being composed by aurweb on a regular basis.  
Basically it's dumping package data into a gzip compressed JSON file.  
Turns out that this file does contain all the necessary information that is being exposed by the /rpc API. Nice!

### Approach

We periodically fetch the file (`packages-meta-ext-v1.json.gz`) with the package data and load it into memory.  
Instead of fetching data from the DB for each we request we utilize the in-memory data to compose our result and return it to the client.  
(In a "real" scenario you'd load this data directly from the DB; Does not matter for our performance tests though)

### Setup

For the sake of benchmarking I've installed aurweb on a bare metal system according to [these instructions](https://gitlab.archlinux.org/archlinux/aurweb/-/blob/master/TESTING)  
The machine is equipped with a 4 core Intel Core i5-4590T CPU, 16 GB RAM and and SSD. Pretty low-spec nowadays.  
Redis is used for caching (does not really make any difference. It seems in terms of the API endpoint it's only used to cache the rate-limit data)

The package data was generated by the `gendummydata.py` script, configured with 80K packages and 95K users.  
That pretty much matches the current numbers in the AUR.  
A small modification has been made to also generate descriptions for the packages otherwise they'd be empty in the DB (which has some effect on certain /rpc requests)  
This data was exported and used for the comparison, so that both, the FastAPI and goaurrpc have the same basis and can be compared properly.

The benchmarks are being run from a Zen2 8-core notebook. The connection between the machines is 1 GBit/s Ethernet.

### Benchmarks

Benchmarks were performed with the Apache Benchmark tool with a total of 1000 requests, running 10 threads in parallel.

#### Results

* "suggest" lookup: **~190x** faster (**1353,17** requests per seconds vs. **7,22** r/s)
* "info" lookup: **~65x** faster (**7580,58** r/s vs. **117,53** r/s)
* "search" lookup: **~33x** faster (**178,51** r/s vs. **5,29**) 

Now these benchmarks have been performed on a pretty low-spec machine.  
Doing the same on a more recent CPU with more cores show much better results.  
The performance basically scales with number of cores where the FastAPI implementation does not...

##### Type "suggest"

- FastAPI

```
Server Software:        uvicorn
Server Hostname:        192.168.0.11
Server Port:            8082

Document Path:          /rpc?v=5&type=suggest&arg=attest
Document Length:        107 bytes

Concurrency Level:      10
Time taken for tests:   138.487 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      502000 bytes
HTML transferred:       107000 bytes
Requests per second:    7.22 [#/sec] (mean)
Time per request:       1384.870 [ms] (mean)
Time per request:       138.487 [ms] (mean, across all concurrent requests)
Transfer rate:          3.54 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.1      0       1
Processing:   246 1381  41.1   1380    1454
Waiting:      245 1372  40.9   1371    1446
Total:        247 1381  41.1   1380    1454
```

- goaurrpc

```
Server Software:        
Server Hostname:        192.168.0.11
Server Port:            10666

Document Path:          /rpc?v=5&type=suggest&arg=attest
Document Length:        107 bytes

Concurrency Level:      10
Time taken for tests:   0.739 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      216000 bytes
HTML transferred:       107000 bytes
Requests per second:    1353.17 [#/sec] (mean)
Time per request:       7.390 [ms] (mean)
Time per request:       0.739 [ms] (mean, across all concurrent requests)
Transfer rate:          285.43 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.1      0       1
Processing:     3    7   2.0      5      15
Waiting:        3    7   2.0      5      15
Total:          4    7   2.0      6      15
```

##### Type "info"

- FastAPI

```
Server Software:        uvicorn
Server Hostname:        192.168.0.11
Server Port:            8082

Document Path:          /rpc?v=5&type=info&arg=attest
Document Length:        804 bytes

Concurrency Level:      10
Time taken for tests:   8.508 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      1199000 bytes
HTML transferred:       804000 bytes
Requests per second:    117.53 [#/sec] (mean)
Time per request:       85.084 [ms] (mean)
Time per request:       8.508 [ms] (mean, across all concurrent requests)
Transfer rate:          137.62 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.2      1       2
Processing:    40   84  12.1     81     138
Waiting:       33   75  11.2     73     131
Total:         41   85  12.0     82     138
```

- goaurrpc

```
Server Software:        
Server Hostname:        192.168.0.11
Server Port:            10666

Document Path:          /rpc?v=5&type=info&arg=attest
Document Length:        804 bytes

Concurrency Level:      10
Time taken for tests:   0.132 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      913000 bytes
HTML transferred:       804000 bytes
Requests per second:    7580.58 [#/sec] (mean)
Time per request:       1.319 [ms] (mean)
Time per request:       0.132 [ms] (mean, across all concurrent requests)
Transfer rate:          6758.86 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.1      1       1
Processing:     0    1   0.2      1       2
Waiting:        0    1   0.2      1       1
Total:          1    1   0.3      1       2
```

##### Type "search"

- FastAPI

```
Server Software:        uvicorn
Server Hostname:        192.168.0.11
Server Port:            8082

Document Path:          /rpc?v=5&type=search&arg=attest
Document Length:        3211 bytes

Concurrency Level:      10
Time taken for tests:   188.875 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      3607000 bytes
HTML transferred:       3211000 bytes
Requests per second:    5.29 [#/sec] (mean)
Time per request:       1888.752 [ms] (mean)
Time per request:       188.875 [ms] (mean, across all concurrent requests)
Transfer rate:          18.65 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.1      0       1
Processing:   208 1885  56.2   1886    1944
Waiting:      207 1876  56.0   1877    1936
Total:        209 1885  56.2   1886    1944
```

- goaurrpc

```
Server Software:        
Server Hostname:        192.168.0.11
Server Port:            10666

Document Path:          /rpc?v=5&type=search&arg=attest
Document Length:        3211 bytes

Concurrency Level:      10
Time taken for tests:   5.602 seconds
Complete requests:      1000
Failed requests:        0
Total transferred:      3299000 bytes
HTML transferred:       3211000 bytes
Requests per second:    178.51 [#/sec] (mean)
Time per request:       56.019 [ms] (mean)
Time per request:       5.602 [ms] (mean, across all concurrent requests)
Transfer rate:          575.11 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    1   0.2      1       1
Processing:    22   55  23.0     50     185
Waiting:       22   54  22.1     49     185
Total:         22   56  23.0     51     186
``` 

### Concerns

- No live data, since the data is being cached in memory and only reloaded every 5 minutes:  

Data could be reloaded more frequently.  
Loading the data from a JSON file or directly from the AUR webserver takes around 2 seconds.
Re-loading data every minute or even in a 10 second interval would be perfectly possible.  
That would only make sense if data is being retrieved directly from the DB though, the JSON file is only exported every 5 minutes...  

- Memory consumption?  

After startup, once all data is loaded the amount of memory that is allocated for the process is ~230 MB  
When data is being re-loaded periodically, the consumption increases temporarily to about ~430 MB   
until the "old set of data" is being garbage-collected.
Sometimes this might take a while. During my tests I have never seen to get bigger than ~500 MB  
(we could forcefully run the GC, but that does not really make sense.)

### How to build

- Download repository `git clone https://github.com/moson-mo/goaurrpc.git`
- `cd goaurrpc`
- Build with: `go build cmd/goaurrpc/goaurrpc.go`
- This will create a binary `goaurrpc`

### Config file

See `sample.conf` file. The config file can be loaded by specifying "-c" parameter when running goaurrpc.  
For example: `./goaurrpc -c sample.conf`.
If this parameter is not passed, the default config will be used (sample.conf contains the defaults).  

### Notes

Again this is just a quick and dirty POC implementation written in a couple of days.  
Needs some more work to get it "production-grade" ready :wink:

### Test endpoint

A goaurrpc endpoint can be found here for testing:
`http://server.moson.rocks:10666/rpc`